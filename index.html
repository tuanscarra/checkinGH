<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</title>
    <!-- Gi·ªØ nguy√™n giao di·ªán c≈© -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color:#111827; }
        .card { background: #fff; border-radius: 12px; padding: 24px; box-shadow: 0 6px 18px rgba(15,23,42,0.06); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #2563eb; border-radius: 50%; width: 36px; height: 36px; animation: spin 1s linear infinite; }
        @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
        #image-preview { max-width: 100%; max-height: 200px; border-radius: 6px; object-fit: cover; display:block; margin-top:8px; }
        .hidden { display: none; }
    </style>
</head>
<body class="antialiased">

<!-- LOGIN VIEW (always show first) -->
<div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
  <div class="card w-full max-w-2xl">
    <h1 class="text-3xl font-bold text-center text-blue-600 mb-4">Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</h1>
    <div class="max-w-md mx-auto">
      <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
      <input id="login-email" type="email" placeholder="Nh·∫≠p email do c√¥ng ty c·∫•p" class="w-full px-4 py-3 border rounded-lg mb-3" />
      <div class="flex justify-end gap-3 items-center">
        <p id="login-error" class="text-red-500 text-sm mr-auto"></p>
        <button id="login-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
          <i class="fas fa-sign-in-alt mr-2"></i>ƒêƒÉng nh·∫≠p
        </button>
      </div>
      <p class="text-xs text-gray-500 mt-3">N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, li√™n h·ªá qu·∫£n tr·ªã ƒë·ªÉ ƒë∆∞·ª£c c·∫•p email.</p>
    </div>
  </div>
</div>

<!-- APP VIEW (hidden until login) -->
<main id="app-view" class="hidden container mx-auto p-6 max-w-4xl">
  <header class="text-center mb-6">
    <h1 class="text-4xl font-bold text-blue-600">Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</h1>
    <div class="mt-3 text-sm text-gray-600" id="user-info-line">
      <!-- "ƒêƒÉng nh·∫≠p: <email> [ƒêƒÉng xu·∫•t]" s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y -->
    </div>
  </header>

  <!-- Check-in form -->
  <section class="card mb-8">
    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">T·∫°o Check-in M·ªõi</h2>
    <form id="checkin-form">
      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2"><i class="fas fa-camera mr-2"></i>·∫¢nh Check-in</label>
        <input type="file" id="photo" accept="image/*" class="file-input" />
        <img id="image-preview" class="hidden" alt="Xem tr∆∞·ªõc ·∫£nh" />
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2"><i class="fas fa-map-marker-alt mr-2"></i>V·ªã tr√≠ (nh·∫≠p th·ªß c√¥ng)</label>
        <div class="flex">
          <input type="text" id="manual-location" placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1" class="flex-1 px-4 py-3 border-t border-b border-l rounded-l-lg" />
          <button type="button" id="get-location-btn" class="bg-green-500 text-white px-4 rounded-r-lg hover:bg-green-600" title="L·∫•y ƒë·ªãa ch·ªâ t·ª´ ƒë·ªãnh v·ªã">üìç</button>
        </div>
        <p id="location-note" class="text-xs text-gray-400 mt-1">Ch∆∞a c·∫•u h√¨nh Google Maps API Key ‚Üí n√∫t s·∫Ω b√°o l·ªói. G·∫Øn key v√†o bi·∫øn <code>GOOGLE_MAPS_API_KEY</code> ƒë·ªÉ d√πng.</p>
      </div>

      <div class="mb-4">
        <label class="block text-gray-700 font-medium mb-2"><i class="fas fa-pencil-alt mr-2"></i>Ghi Ch√∫</label>
        <textarea id="notes" rows="4" placeholder="V√≠ d·ª•: Giao h√†ng cho anh A, ƒë√£ nh·∫≠n ƒë·ªß ti·ªÅn..." class="w-full px-4 py-3 border rounded-lg"></textarea>
      </div>

      <div class="flex items-center justify-end">
        <div id="submit-loader" class="loader hidden mr-4"></div>
        <button type="submit" id="submit-btn" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
          <i class="fas fa-paper-plane mr-2"></i>G·ª≠i Check-in
        </button>
      </div>

      <p id="error-message" class="text-red-500 text-center mt-3"></p>
    </form>
  </section>

  <!-- User's history -->
  <section class="mb-8">
    <h2 class="text-2xl font-semibold mb-4 border-b pb-2">L·ªãch S·ª≠ Check-in</h2>
    <div id="checkin-list" class="space-y-6">
      <p class="text-gray-500">Ch∆∞a c√≥ l·∫ßn check-in n√†o.</p>
    </div>
  </section>

  <!-- Admin panel (hidden for regular users) -->
  <section id="admin-panel" class="card hidden">
    <h2 class="text-2xl font-semibold mb-4 border-b pb-2 text-red-600">Qu·∫£n L√Ω To√†n B·ªô Check-in (Admin)</h2>

    <div class="mb-4 flex gap-3">
      <input id="admin-filter-text" type="text" placeholder="T√¨m theo ghi ch√∫..." class="flex-1 px-4 py-2 border rounded-lg" />
      <input id="admin-filter-date" type="date" class="px-4 py-2 border rounded-lg" />
      <button id="admin-clear-filters" class="px-4 py-2 bg-gray-500 text-white rounded-lg">X√≥a l·ªçc</button>
    </div>

    <div id="admin-list" class="space-y-4"></div>
  </section>
</main>

<!-- Firebase + Logic -->
<script type="module">
  // Firebase SDK imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

  // --- CONFIG (ƒëi·ªÅn s·∫µn cho b·∫°n) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBTO8b7SE1-u7cz0XImdbCuSzTaGtn-V8c",
    authDomain: "quanly-8c2da.firebaseapp.com",
    projectId: "quanly-8c2da",
    storageBucket: "quanly-8c2da.firebasestorage.app",
    messagingSenderId: "1078363909076",
    appId: "1:1078363909076:web:0f4c92fa8750c1f79b0441"
  };

  // N·∫øu c√≥ Google Maps API key, g√°n v√†o ƒë√¢y ƒë·ªÉ n√∫t üìç ho·∫°t ƒë·ªông (reverse geocoding)
  const GOOGLE_MAPS_API_KEY = ""; // <-- g√°n key n·∫øu c√≥

  // Quy t·∫Øc ƒëƒÉng nh·∫≠p
  const ADMIN_EMAIL = "ad_ql@gmail.com";
  const ADMIN_PASS = "NS113321";
  const COMMON_PASS = "112233";

  // Kh·ªüi t·∫°o Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // DOM
  const loginView = document.getElementById("login-view");
  const loginEmailEl = document.getElementById("login-email");
  const loginBtn = document.getElementById("login-btn");
  const loginErrorEl = document.getElementById("login-error");

  const appView = document.getElementById("app-view");
  const userInfoLine = document.getElementById("user-info-line");
  const logoutBtnHolder = document.getElementById("user-info-line");

  const photoInput = document.getElementById("photo");
  const imagePreview = document.getElementById("image-preview");
  const manualLocationInput = document.getElementById("manual-location");
  const getLocationBtn = document.getElementById("get-location-btn");
  const notesInput = document.getElementById("notes");
  const submitBtn = document.getElementById("submit-btn");
  const submitLoader = document.getElementById("submit-loader");
  const errorMessage = document.getElementById("error-message");

  const checkinList = document.getElementById("checkin-list");

  const adminPanel = document.getElementById("admin-panel");
  const adminList = document.getElementById("admin-list");
  const adminFilterText = document.getElementById("admin-filter-text");
  const adminFilterDate = document.getElementById("admin-filter-date");
  const adminClearFilters = document.getElementById("admin-clear-filters");

  // State
  let currentUser = null;
  let currentUserEmail = "";
  let isAdmin = false;
  let unsubscribeUser = null;
  let unsubscribeAdmin = null;

  // --- Functions ---
  function showLogin() {
    loginView.classList.remove("hidden");
    appView.classList.add("hidden");
    adminPanel.classList.add("hidden");
    loginErrorEl.textContent = "";
  }

  function showApp() {
    loginView.classList.add("hidden");
    appView.classList.remove("hidden");
    // user info + logout button
    userInfoLine.innerHTML = `ƒêƒÉng nh·∫≠p: <strong>${currentUserEmail}</strong> &nbsp; <button id="logout-btn" class="bg-red-500 text-white px-3 py-1 rounded ml-4">ƒêƒÉng xu·∫•t</button>`;
    document.getElementById("logout-btn").addEventListener("click", async () => {
      // sign out and cleanup
      try {
        if (unsubscribeUser) { unsubscribeUser(); unsubscribeUser = null; }
        if (unsubscribeAdmin) { unsubscribeAdmin(); unsubscribeAdmin = null; }
        await signOut(auth);
      } catch (e) {
        console.error("Error signOut", e);
      } finally {
        currentUser = null;
        currentUserEmail = "";
        isAdmin = false;
        checkinList.innerHTML = `<p class="text-gray-500">Ch∆∞a c√≥ l·∫ßn check-in n√†o.</p>`;
        adminList.innerHTML = "";
        showLogin();
      }
    });
  }

  // Login when click button (no auto-login)
  loginBtn.addEventListener("click", async () => {
    const email = loginEmailEl.value.trim().toLowerCase();
    if (!email) {
      loginErrorEl.textContent = "Vui l√≤ng nh·∫≠p email";
      return;
    }
    loginErrorEl.textContent = "";
    const pass = (email === ADMIN_EMAIL) ? ADMIN_PASS : COMMON_PASS;
    try {
      const cred = await signInWithEmailAndPassword(auth, email, pass);
      // onAuthStateChanged will handle UI; but set some immediate vars
      currentUser = cred.user;
      currentUserEmail = cred.user.email || email;
      isAdmin = (currentUserEmail.toLowerCase() === ADMIN_EMAIL);
      showApp();
      startUserListener();
      if (isAdmin) startAdminListener();
    } catch (err) {
      console.error("Login error:", err);
      loginErrorEl.textContent = "Sai email ho·∫∑c t√†i kho·∫£n ch∆∞a ƒë∆∞·ª£c c·∫•p";
    }
  });

  // Firestore listeners
  function startUserListener() {
    if (!auth.currentUser) return;
    // unsubscribe previous if any
    if (unsubscribeUser) unsubscribeUser();
    const colRef = collection(db, `users/${auth.currentUser.uid}/checkins`);
    const q = query(colRef, orderBy("createdAt", "desc"));
    unsubscribeUser = onSnapshot(q, snapshot => {
      renderSnapshotToList(snapshot, checkinList, false); // show email inside render
    }, err => {
      console.error("User snapshot error:", err);
    });
  }

  function startAdminListener() {
    if (!isAdmin) return;
    if (unsubscribeAdmin) unsubscribeAdmin();
    // collectionGroup to get all checkins across users
    const q = query(collectionGroup(db, "checkins"), orderBy("createdAt", "desc"));
    unsubscribeAdmin = onSnapshot(q, snapshot => {
      renderSnapshotToList(snapshot, adminList, true); // admin: show email and enable filters
    }, err => {
      console.error("Admin snapshot error:", err);
    });
  }

  // Render helper
  function renderSnapshotToList(snapshot, container, showEmail) {
    container.innerHTML = "";
    if (snapshot.empty) {
      container.innerHTML = `<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`;
      return;
    }
    snapshot.forEach(doc => {
      const data = doc.data();
      const timeStr = data.createdAt ? (data.createdAt.toDate().toLocaleString("vi-VN")) : "";
      const emailLine = data.userEmail ? `<p class="text-xs text-gray-500 mb-1"><strong>${data.userEmail}</strong></p>` : "";
      const html = `
        <div class="bg-white p-4 rounded shadow">
          ${showEmail ? emailLine : ""}
          <p class="text-sm text-gray-500 mb-2">${timeStr}</p>
          <p class="mb-2 text-gray-800 whitespace-pre-wrap">${data.notes || "<em>Kh√¥ng c√≥ ghi ch√∫</em>"}</p>
          <p class="text-sm text-gray-800 mb-2"><i class="fas fa-map-marker-alt mr-2"></i>${data.manualLocation || "<em>Kh√¥ng c√≥ v·ªã tr√≠</em>"}</p>
          <a href="${data.photoURL}" target="_blank"><img src="${data.photoURL}" alt="·∫¢nh" class="rounded max-w-xs"></a>
        </div>
      `;
      container.insertAdjacentHTML("beforeend", html);
    });
  }

  // Submit checkin
  document.getElementById("checkin-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!auth.currentUser) {
      errorMessage.textContent = "Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc khi g·ª≠i.";
      return;
    }
    const file = photoInput.files[0];
    const manualLocation = manualLocationInput.value.trim();
    const notes = notesInput.value.trim();
    if (!file) { errorMessage.textContent = "Vui l√≤ng ch·ªçn ·∫£nh check-in."; return; }
    if (!manualLocation) { errorMessage.textContent = "Vui l√≤ng nh·∫≠p v·ªã tr√≠."; return; }
    errorMessage.textContent = "";
    submitLoader.classList.remove("hidden");
    submitBtn.disabled = true;

    try {
      const path = `users/${auth.currentUser.uid}/checkins/${Date.now()}_${file.name}`;
      const storageRef = ref(storage, path);
      const snap = await uploadBytes(storageRef, file);
      const url = await getDownloadURL(snap.ref);
      await addDoc(collection(db, `users/${auth.currentUser.uid}/checkins`), {
        photoURL: url,
        manualLocation,
        notes,
        createdAt: serverTimestamp(),
        userId: auth.currentUser.uid,
        userEmail: currentUserEmail
      });
      // reset form
      document.getElementById("checkin-form").reset();
      imagePreview.classList.add("hidden");
      alert("Check-in th√†nh c√¥ng!");
    } catch (err) {
      console.error("Upload error:", err);
      errorMessage.textContent = `L·ªói khi g·ª≠i: ${err.message || err}`;
    } finally {
      submitLoader.classList.add("hidden");
      submitBtn.disabled = false;
    }
  });

  // Image preview
  photoInput.addEventListener("change", (e) => {
    const f = e.target.files[0];
    if (!f) { imagePreview.classList.add("hidden"); return; }
    const reader = new FileReader();
    reader.onload = ev => {
      imagePreview.src = ev.target.result;
      imagePreview.classList.remove("hidden");
    };
    reader.readAsDataURL(f);
  });

  // Get location button (reverse geocode only if key provided)
  getLocationBtn.addEventListener("click", () => {
    if (!GOOGLE_MAPS_API_KEY) {
      alert("Ch∆∞a c·∫•u h√¨nh Google Maps API Key");
      return;
    }
    if (!navigator.geolocation) {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã");
      return;
    }
    getLocationBtn.disabled = true;
    getLocationBtn.textContent = "ƒêang l·∫•y...";
    navigator.geolocation.getCurrentPosition(async (pos) => {
      try {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        const resp = await fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`);
        const data = await resp.json();
        if (data.results && data.results[0]) {
          manualLocationInput.value = data.results[0].formatted_address;
        } else {
          alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ t·ª´ t·ªça ƒë·ªô");
        }
      } catch (err) {
        console.error(err);
        alert("L·ªói khi g·ªçi Google Maps API");
      } finally {
        getLocationBtn.disabled = false;
        getLocationBtn.textContent = "üìç";
      }
    }, (err) => {
      console.error(err);
      alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠ t·ª´ thi·∫øt b·ªã");
      getLocationBtn.disabled = false;
      getLocationBtn.textContent = "üìç";
    });
  });

  // Admin filters (filter client-side)
  adminFilterText.addEventListener("input", () => applyAdminFilters());
  adminFilterDate.addEventListener("change", () => applyAdminFilters());
  adminClearFilters.addEventListener("click", () => { adminFilterText.value=""; adminFilterDate.value=""; applyAdminFilters(); });

  let lastAdminSnapshot = null;
  function applyAdminFilters() {
    if (!lastAdminSnapshot) return;
    const text = adminFilterText.value.trim().toLowerCase();
    const date = adminFilterDate.value; // yyyy-mm-dd
    const filtered = [];
    lastAdminSnapshot.forEach(doc => {
      const d = doc.data();
      let okText = true, okDate = true;
      if (text) okText = (d.notes || "").toLowerCase().includes(text);
      if (date && d.createdAt) {
        const dStr = d.createdAt.toDate().toISOString().split("T")[0];
        okDate = (dStr === date);
      }
      if (okText && okDate) filtered.push(d);
    });
    // render filtered
    adminList.innerHTML = "";
    if (filtered.length===0) { adminList.innerHTML = `<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; }
    filtered.forEach(data => {
      const timeStr = data.createdAt ? data.createdAt.toDate().toLocaleString("vi-VN") : "";
      adminList.insertAdjacentHTML("beforeend", `
        <div class="bg-white p-4 rounded shadow">
          <p class="text-xs text-gray-500 mb-1"><strong>${data.userEmail || ""}</strong></p>
          <p class="text-sm text-gray-500 mb-2">${timeStr}</p>
          <p class="mb-2">${data.notes || ""}</p>
          <p class="text-sm text-gray-700 mb-2">${data.manualLocation || ""}</p>
          <a href="${data.photoURL}" target="_blank"><img src="${data.photoURL}" class="rounded max-w-xs"></a>
        </div>
      `);
    });
  }

  // keep lastAdminSnapshot updated inside startAdminListener
  function startAdminListener() {
    if (!isAdmin) return;
    if (unsubscribeAdmin) unsubscribeAdmin();
    const q = query(collectionGroup(db, "checkins"), orderBy("createdAt", "desc"));
    unsubscribeAdmin = onSnapshot(q, snapshot => {
      lastAdminSnapshot = snapshot;
      // render initial (no filters)
      adminList.innerHTML = "";
      if (snapshot.empty) { adminList.innerHTML = `<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu.</p>`; return; }
      snapshot.forEach(doc => {
        const d = doc.data();
        const timeStr = d.createdAt ? d.createdAt.toDate().toLocaleString("vi-VN") : "";
        adminList.insertAdjacentHTML("beforeend", `
          <div class="bg-white p-4 rounded shadow">
            <p class="text-xs text-gray-500 mb-1"><strong>${d.userEmail || ""}</strong></p>
            <p class="text-sm text-gray-500 mb-2">${timeStr}</p>
            <p class="mb-2">${d.notes || ""}</p>
            <p class="text-sm text-gray-700 mb-2">${d.manualLocation || ""}</p>
            <a href="${d.photoURL}" target="_blank"><img src="${d.photoURL}" class="rounded max-w-xs"></a>
          </div>
        `);
      });
    }, err => console.error(err));
  }

  // Note: we call startAdminListener from login flow after isAdmin set.
  // But ensure to use same function above when needed (replacing previous definition)
  // So replace startAdminListener reference:
  // (we already defined it here; ensure not duplicated)

  // END
</script>
</body>
</html>
