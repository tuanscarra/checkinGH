<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: Arial, sans-serif; background: #f5f6fa; margin: 0; padding: 0; }
    .container { max-width: 800px; margin: auto; padding: 20px; }
    .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    h1 { color: #2563eb; }
    button { cursor: pointer; }
    .hidden { display: none; }
    #image-preview { max-width: 200px; border-radius: 8px; margin-top: 10px; display: none; }
    .logout-btn { background: red; color: white; border: none; padding: 6px 12px; border-radius: 5px; }
    .checkin-item img { max-width: 150px; border-radius: 6px; margin-top: 5px; }
</style>
</head>
<body>

<!-- ƒêƒÉng nh·∫≠p -->
<div id="login-view" class="container">
    <div class="card">
        <h2 style="text-align:center">ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
        <label>Email:</label>
        <input type="email" id="login-email" placeholder="Nh·∫≠p email" style="width:100%;padding:8px;margin-bottom:10px">
        <div id="password-wrapper" class="hidden">
            <label>M·∫≠t kh·∫©u:</label>
            <input type="password" id="login-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" style="width:100%;padding:8px;margin-bottom:10px">
        </div>
        <button id="login-btn" style="width:100%;padding:10px;background:#2563eb;color:white;border:none;border-radius:5px">ƒêƒÉng nh·∫≠p</button>
        <p id="login-error" style="color:red;text-align:center;margin-top:10px"></p>
    </div>
</div>

<!-- App -->
<div id="app-view" class="container hidden">
    <div class="flex" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px">
        <h1>Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</h1>
        <div>
            <span id="user-info" style="margin-right:10px"></span>
            <button id="logout-btn" class="logout-btn">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <!-- Form check-in -->
    <div class="card">
        <h3><i class="fa-solid fa-plus"></i> T·∫°o Check-in M·ªõi</h3>
        <form id="checkin-form">
            <label><i class="fa-solid fa-camera"></i> ·∫¢nh Check-in</label>
            <input type="file" id="photo" accept="image/*" required>
            <img id="image-preview" />

            <label><i class="fa-solid fa-location-dot"></i> V·ªã tr√≠ (nh·∫≠p th·ªß c√¥ng)</label>
            <div style="display:flex">
                <input type="text" id="manual-location" placeholder="VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1" style="flex:1;padding:8px" required>
                <button type="button" id="get-location-btn" style="background:green;color:white;border:none;padding:0 12px">üìç</button>
            </div>

            <label><i class="fa-solid fa-pen"></i> Ghi Ch√∫</label>
            <textarea id="notes" rows="3" placeholder="VD: Giao h√†ng cho anh A..." style="width:100%;padding:8px"></textarea>

            <button type="submit" style="margin-top:10px;background:#2563eb;color:white;border:none;padding:10px 15px;border-radius:5px">
                <i class="fa-solid fa-paper-plane"></i> G·ª≠i Check-in
            </button>
        </form>
    </div>

    <!-- L·ªãch s·ª≠ -->
    <div class="card">
        <h3>L·ªãch S·ª≠ Check-in</h3>
        <div id="checkin-list"></div>
    </div>

    <!-- Admin -->
    <div id="admin-panel" class="card hidden">
        <h3 style="color:red">T·∫•t C·∫£ Check-in (Admin)</h3>
        <div id="admin-list"></div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBTO8b7SE1-u7cz0XImdbCuSzTaGtn-V8c",
  authDomain: "quanly-8c2da.firebaseapp.com",
  projectId: "quanly-8c2da",
  storageBucket: "quanly-8c2da.firebasestorage.app",
  messagingSenderId: "1078363909076",
  appId: "1:1078363909076:web:0f4c92fa8750c1f79b0441"
};

const GOOGLE_MAPS_API_KEY = ""; // th√™m key n·∫øu mu·ªën auto l·∫•y ƒë·ªãa ch·ªâ

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const COMMON_PASS = "112233";
let currentUserEmail = "";
let isAdmin = false;

// Hi·ªÉn th·ªã √¥ m·∫≠t kh·∫©u n·∫øu email b·∫Øt ƒë·∫ßu b·∫±ng AD_
document.getElementById("login-email").addEventListener("input", () => {
    const emailVal = document.getElementById("login-email").value.trim();
    if (emailVal.toLowerCase().startsWith("ad_")) {
        document.getElementById("password-wrapper").classList.remove("hidden");
    } else {
        document.getElementById("password-wrapper").classList.add("hidden");
    }
});

// ƒêƒÉng nh·∫≠p
document.getElementById("login-btn").addEventListener("click", async () => {
    const email = document.getElementById("login-email").value.trim();
    const pass = email.toLowerCase().startsWith("ad_") 
        ? document.getElementById("login-password").value 
        : COMMON_PASS;

    if (!email || (!pass && email.toLowerCase().startsWith("ad_"))) {
        document.getElementById("login-error").textContent = "Vui l√≤ng nh·∫≠p th√¥ng tin";
        return;
    }
    try {
        const userCred = await signInWithEmailAndPassword(auth, email, pass);
        currentUserEmail = userCred.user.email;
        isAdmin = currentUserEmail.toLowerCase().startsWith("ad_");
        showApp();
        loadUserHistory();
        if (isAdmin) loadAdminHistory();
    } catch {
        document.getElementById("login-error").textContent = "Sai th√¥ng tin ƒëƒÉng nh·∫≠p";
    }
});

function showApp() {
    document.getElementById("login-view").classList.add("hidden");
    document.getElementById("app-view").classList.remove("hidden");
    document.getElementById("user-info").textContent = `${currentUserEmail} ${isAdmin ? "(Admin)" : ""}`;
}

document.getElementById("logout-btn").addEventListener("click", async () => {
    await signOut(auth);
    location.reload();
});

function loadUserHistory() {
    const q = collection(db, `/users/${auth.currentUser.uid}/checkins`);
    onSnapshot(q, (snapshot) => renderList(snapshot, document.getElementById("checkin-list"), true));
}

function loadAdminHistory() {
    document.getElementById("admin-panel").classList.remove("hidden");
    const q = collectionGroup(db, "checkins");
    onSnapshot(q, (snapshot) => renderList(snapshot, document.getElementById("admin-list"), true));
}

function renderList(snapshot, container, showEmail) {
    container.innerHTML = "";
    snapshot.forEach(doc => {
        const d = doc.data();
        const time = d.createdAt?.toDate().toLocaleString("vi-VN") || "";
        container.innerHTML += `
            <div class="checkin-item">
                ${showEmail ? `<b>${d.userEmail || ""}</b><br>` : ""}
                <small>${time}</small><br>
                <span>${d.manualLocation || ""}</span><br>
                <span>${d.notes || ""}</span><br>
                <img src="${d.photoURL}" alt="Checkin">
            </div>
            <hr>
        `;
    });
}

document.getElementById("checkin-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const photoFile = document.getElementById("photo").files[0];
    const location = document.getElementById("manual-location").value.trim();
    const notes = document.getElementById("notes").value.trim();
    if (!photoFile || !location) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin");
        return;
    }
    const storageRef = ref(storage, `/users/${auth.currentUser.uid}/checkins/${Date.now()}_${photoFile.name}`);
    const snap = await uploadBytes(storageRef, photoFile);
    const photoURL = await getDownloadURL(snap.ref);
    await addDoc(collection(db, `/users/${auth.currentUser.uid}/checkins`), {
        photoURL, manualLocation: location, notes,
        createdAt: serverTimestamp(),
        userId: auth.currentUser.uid,
        userEmail: currentUserEmail
    });
    e.target.reset();
    document.getElementById("image-preview").style.display = "none";
    alert("Check-in th√†nh c√¥ng!");
});

document.getElementById("photo").addEventListener("change", (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
            document.getElementById("image-preview").src = ev.target.result;
            document.getElementById("image-preview").style.display = "block";
        };
        reader.readAsDataURL(file);
    } else {
        document.getElementById("image-preview").style.display = "none";
    }
});

document.getElementById("get-location-btn").addEventListener("click", () => {
    if (!GOOGLE_MAPS_API_KEY) {
        alert("Ch∆∞a c·∫•u h√¨nh Google Maps API Key");
        return;
    }
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`)
                .then(r => r.json())
                .then(data => {
                    if (data.results && data.results[0]) {
                        document.getElementById("manual-location").value = data.results[0].formatted_address;
                    }
                });
        }, () => alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠"));
    } else {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã");
    }
});
</script>
</body>
</html>
