<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Check-in Giao H√†ng</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body { background-color: #f9fafb; font-family: Arial, sans-serif; }
    #image-preview { max-height: 200px; margin-top: 10px; border-radius: 8px; }
</style>
</head>
<body class="text-gray-800">

<!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
<div id="login-view" class="min-h-screen flex items-center justify-center bg-gray-100">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-sm">
    <h2 class="text-xl font-bold text-center mb-4">ƒêƒÉng nh·∫≠p h·ªá th·ªëng</h2>
    <input id="login-email" type="email" placeholder="Nh·∫≠p email" class="w-full mb-3 px-3 py-2 border rounded">
    <button id="login-btn" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ƒêƒÉng nh·∫≠p</button>
    <p id="login-error" class="text-red-500 mt-2 text-center text-sm"></p>
  </div>
</div>

<!-- Giao di·ªán ch√≠nh -->
<div id="app-view" class="hidden max-w-5xl mx-auto p-4">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-blue-600">Qu·∫£n L√Ω Check-in</h1>
    <div>
      <span id="user-info" class="text-sm text-gray-700"></span>
      <button id="logout-btn" class="ml-3 bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <!-- Form check-in -->
  <div class="bg-white p-5 rounded-lg shadow mb-8">
    <h2 class="text-lg font-semibold mb-4 border-b pb-2">T·∫°o check-in</h2>
    <form id="checkin-form">
      <input type="file" id="photo" accept="image/*" class="mb-3 block w-full" required>
      <img id="image-preview" class="hidden"/>

      <div class="flex mb-3">
        <input type="text" id="manual-location" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ" class="flex-1 px-3 py-2 border rounded-l" required>
        <button type="button" id="get-location-btn" class="bg-green-500 text-white px-4 rounded-r">üìç</button>
      </div>

      <textarea id="notes" rows="3" placeholder="Ghi ch√∫" class="w-full mb-3 px-3 py-2 border rounded"></textarea>
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">G·ª≠i check-in</button>
    </form>
  </div>

  <!-- L·ªãch s·ª≠ c·ªßa user -->
  <div>
    <h2 class="text-lg font-semibold mb-4 border-b pb-2">L·ªãch s·ª≠ check-in</h2>
    <div id="checkin-list" class="space-y-4"></div>
  </div>

  <!-- Admin xem t·∫•t c·∫£ -->
  <div id="admin-panel" class="hidden mt-10">
    <h2 class="text-lg font-semibold mb-4 border-b pb-2 text-red-600">T·∫•t c·∫£ check-in</h2>
    <div id="admin-list" class="space-y-4"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, collectionGroup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBTO8b7SE1-u7cz0XImdbCuSzTaGtn-V8c",
  authDomain: "quanly-8c2da.firebaseapp.com",
  projectId: "quanly-8c2da",
  storageBucket: "quanly-8c2da.firebasestorage.app",
  messagingSenderId: "1078363909076",
  appId: "1:1078363909076:web:0f4c92fa8750c1f79b0441"
};

const GOOGLE_MAPS_API_KEY = ""; // th√™m key n·∫øu mu·ªën auto l·∫•y ƒë·ªãa ch·ªâ

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const ADMIN_EMAIL = "ad_ql@gmail.com";
const ADMIN_PASS = "NS113321";
const COMMON_PASS = "112233";

let currentUserEmail = "";
let isAdmin = false;

// Login
document.getElementById("login-btn").addEventListener("click", async () => {
  const email = document.getElementById("login-email").value.trim();
  if (!email) {
    document.getElementById("login-error").textContent = "Vui l√≤ng nh·∫≠p email";
    return;
  }
  const pass = email.toLowerCase() === ADMIN_EMAIL ? ADMIN_PASS : COMMON_PASS;
  try {
    const userCred = await signInWithEmailAndPassword(auth, email, pass);
    currentUserEmail = userCred.user.email;
    isAdmin = currentUserEmail.toLowerCase() === ADMIN_EMAIL;
    showApp();
    loadUserHistory();
    if (isAdmin) loadAdminHistory();
  } catch {
    document.getElementById("login-error").textContent = "Sai email ho·∫∑c ch∆∞a ƒë∆∞·ª£c c·∫•p quy·ªÅn";
  }
});

// Hi·ªÉn th·ªã app
function showApp() {
  document.getElementById("login-view").classList.add("hidden");
  document.getElementById("app-view").classList.remove("hidden");
  document.getElementById("user-info").textContent = `${currentUserEmail} ${isAdmin ? "(Admin)" : ""}`;
}

// ƒêƒÉng xu·∫•t
document.getElementById("logout-btn").addEventListener("click", async () => {
  await signOut(auth);
  document.getElementById("app-view").classList.add("hidden");
  document.getElementById("login-view").classList.remove("hidden");
  currentUserEmail = "";
  isAdmin = false;
  document.getElementById("checkin-list").innerHTML = "";
  document.getElementById("admin-list").innerHTML = "";
});

// Load l·ªãch s·ª≠ c√° nh√¢n
function loadUserHistory() {
  const q = collection(db, `/users/${auth.currentUser.uid}/checkins`);
  onSnapshot(q, (snapshot) => renderList(snapshot, document.getElementById("checkin-list"), true));
}

// Load t·∫•t c·∫£ (admin)
function loadAdminHistory() {
  document.getElementById("admin-panel").classList.remove("hidden");
  const q = collectionGroup(db, "checkins");
  onSnapshot(q, (snapshot) => renderList(snapshot, document.getElementById("admin-list"), true));
}

// Render danh s√°ch
function renderList(snapshot, container, showEmail) {
  container.innerHTML = "";
  snapshot.forEach(doc => {
    const d = doc.data();
    const time = d.createdAt?.toDate().toLocaleString("vi-VN") || "";
    container.innerHTML += `
      <div class="bg-white p-4 rounded shadow">
        ${showEmail ? `<p class="text-xs text-gray-500 mb-1"><b>${d.userEmail || ""}</b></p>` : ""}
        <p class="text-sm text-gray-500 mb-2">${time}</p>
        <p class="mb-1">${d.notes || ""}</p>
        <p class="text-sm text-gray-700 mb-2">${d.manualLocation || ""}</p>
        <a href="${d.photoURL}" target="_blank"><img src="${d.photoURL}" class="rounded max-w-xs"></a>
      </div>
    `;
  });
}

// Submit check-in
document.getElementById("checkin-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const photoFile = document.getElementById("photo").files[0];
  const location = document.getElementById("manual-location").value.trim();
  const notes = document.getElementById("notes").value.trim();
  if (!photoFile || !location) {
    alert("Vui l√≤ng ch·ªçn ·∫£nh v√† nh·∫≠p v·ªã tr√≠");
    return;
  }
  const storageRef = ref(storage, `/users/${auth.currentUser.uid}/checkins/${Date.now()}_${photoFile.name}`);
  const snap = await uploadBytes(storageRef, photoFile);
  const photoURL = await getDownloadURL(snap.ref);
  await addDoc(collection(db, `/users/${auth.currentUser.uid}/checkins`), {
    photoURL, manualLocation: location, notes,
    createdAt: serverTimestamp(),
    userId: auth.currentUser.uid,
    userEmail: currentUserEmail
  });
  e.target.reset();
  document.getElementById("image-preview").classList.add("hidden");
  alert("Check-in th√†nh c√¥ng!");
});

// Xem tr∆∞·ªõc ·∫£nh
document.getElementById("photo").addEventListener("change", (e) => {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = ev => {
      document.getElementById("image-preview").src = ev.target.result;
      document.getElementById("image-preview").classList.remove("hidden");
    };
    reader.readAsDataURL(file);
  } else {
    document.getElementById("image-preview").classList.add("hidden");
  }
});

// L·∫•y v·ªã tr√≠
document.getElementById("get-location-btn").addEventListener("click", () => {
  if (!GOOGLE_MAPS_API_KEY) {
    alert("Ch∆∞a c·∫•u h√¨nh Google Maps API Key");
    return;
  }
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((pos) => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      fetch(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${GOOGLE_MAPS_API_KEY}`)
        .then(r => r.json())
        .then(data => {
          if (data.results && data.results[0]) {
            document.getElementById("manual-location").value = data.results[0].formatted_address;
          }
        });
    }, () => alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠"));
  } else {
    alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã");
  }
});
</script>
</body>
</html>
