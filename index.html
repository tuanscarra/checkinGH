<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { 
        font-family: Arial, sans-serif; 
        background: #f5f6fa; 
        margin: 0; 
        padding: 0; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh;
    }
    .container { 
        max-width: 960px; 
        margin: auto; 
        padding: 20px; 
    }
    .card { 
        background: white; 
        padding: 30px; 
        border-radius: 10px; 
        box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
        width: 400px;
        max-width: 90%;
    }
    h1 { 
        color: #2563eb; 
        text-align: center; 
        margin-bottom: 20px; 
    }
    button { 
        cursor: pointer; 
        border: none;
    }
    .hidden { 
        display: none; 
    }
    
    /* Login Form Styles */
    .login-form-container { 
        display: flex; 
        flex-direction: column; 
    }
    .login-form-container label { 
        font-weight: bold; 
        margin-bottom: 5px; 
        display: block; 
    }
    .login-form-container input {
        width: 100%;
        padding: 12px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        margin-top: 5px;
        font-size: 16px;
    }
    .login-button-group {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        gap: 10px;
        margin-top: 20px;
    }
    .login-form-container button {
        padding: 12px 25px;
        background: #2563eb;
        color: white;
        border-radius: 5px;
        font-size: 16px;
        flex-shrink: 0;
    }
    .login-info {
        font-size: 14px;
        text-align: center;
        color: #666;
        margin-top: 20px;
    }
    #login-error {
        color: red;
        text-align: center;
        margin-top: 10px;
        min-height: 20px;
    }

    /* App View Styles */
    #app-view .card { width: auto; max-width: none; }
    #app-view h1 { text-align: left; margin-bottom: 0; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .logout-btn { background: red; color: white; padding: 6px 12px; border-radius: 5px; }
    .checkin-item img { max-width: 100%; height: auto; border-radius: 6px; margin-top: 5px; }
    .admin-layout { display: flex; gap: 20px; }
    .user-list-sidebar { flex: 1; border-right: 1px solid #ddd; padding-right: 10px; max-height: 600px; overflow-y: auto; }
    .user-list-sidebar div { cursor: pointer; padding: 10px; border-radius: 5px; margin-bottom: 5px; transition: background-color 0.2s; }
    .user-list-sidebar div:hover { background: #e0e7ff; }
    .user-list-sidebar div.active { background: #2563eb; color: white; }
    .admin-detail-panel { flex: 3; }
    .checkin-item { margin-bottom: 15px; }
</style>
</head>
<body>

<div id="login-view" class="container">
    <div class="card">
        <h1>Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</h1>
        <div class="login-form-container">
            <label for="login-email">Email</label>
            <input type="email" id="login-email" placeholder="Nh·∫≠p email do c√¥ng ty c·∫•p">
            <div id="password-wrapper" class="password-wrapper hidden">
                <label for="login-password">M·∫≠t kh·∫©u</label>
                <input type="password" id="login-password" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            </div>
            <div class="login-button-group">
                <p id="login-error" style="flex: 1; text-align: left; margin: 0;"></p>
                <button id="login-btn"><i class="fa-solid fa-arrow-right-to-bracket"></i> ƒêƒÉng nh·∫≠p</button>
            </div>
            <p class="login-info">N·∫øu ch∆∞a c√≥ t√†i kho·∫£n, li√™n h·ªá qu·∫£n tr·ªã ƒë·ªÉ ƒë∆∞·ª£c c·∫•p email.</p>
        </div>
    </div>
</div>

<div id="app-view" class="container hidden">
    <div class="header">
        <h1>Tr√¨nh Qu·∫£n L√Ω Giao H√†ng</h1>
        <div>
            <span id="user-info" style="margin-right:10px"></span>
            <button id="logout-btn" class="logout-btn">ƒêƒÉng xu·∫•t</button>
        </div>
    </div>

    <div id="checkin-form-card" class="card">
        <h3><i class="fa-solid fa-plus"></i> T·∫°o Check-in M·ªõi</h3>
        <form id="checkin-form">
            <label><i class="fa-solid fa-camera"></i> ·∫¢nh Check-in</label>
            <input type="file" id="photo" accept="image/*" required style="width:100%;margin-bottom:10px">
            <img id="image-preview" />

            <label><i class="fa-solid fa-location-dot"></i> V·ªã tr√≠ (nh·∫≠p th·ªß c√¥ng)</label>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="manual-location" placeholder="VD: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1" style="flex:1;padding:8px" required>
                <button type="button" id="get-location-btn" style="background:green;color:white;border:none;padding:0 12px;border-radius:5px">üìç</button>
            </div>

            <label><i class="fa-solid fa-pen"></i> Ghi Ch√∫</label>
            <textarea id="notes" rows="3" placeholder="VD: Giao h√†ng cho anh A..." style="width:100%;padding:8px;margin-bottom:10px"></textarea>

            <button type="submit" style="background:#2563eb;color:white;border:none;padding:10px 15px;border-radius:5px">
                <i class="fa-solid fa-paper-plane"></i> G·ª≠i Check-in
            </button>
        </form>
    </div>

    <div id="user-history-card" class="card">
        <h3>L·ªãch S·ª≠ Check-in</h3>
        <div id="checkin-list"></div>
    </div>

    <div id="admin-panel" class="card hidden">
        <h3 style="color:red">B·∫£ng ƒëi·ªÅu khi·ªÉn Admin</h3>
        <div class="admin-layout">
            <div class="user-list-sidebar">
                <h4>Danh s√°ch nh√¢n vi√™n</h4>
                <div id="user-list">
                    </div>
            </div>
            <div class="admin-detail-panel">
                <h4>L·ªãch s·ª≠ check-in chi ti·∫øt</h4>
                <div id="admin-checkin-detail">
                    <p>Vui l√≤ng ch·ªçn m·ªôt nh√¢n vi√™n ƒë·ªÉ xem l·ªãch s·ª≠ check-in chi ti·∫øt.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, doc, setDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBTO8b7SE1-u7cz0XImdbCuSzTaGtn-V8c",
    authDomain: "quanly-8c2da.firebaseapp.com",
    projectId: "quanly-8c2da",
    storageBucket: "quanly-8c2da.firebasestorage.app",
    messagingSenderId: "1078363909076",
    appId: "1:1078363909076:web:0f4c92fa8750c1f79b0441"
};

const CLOUDINARY_CLOUD_NAME = "dvx3nu0ip"; // Cloud Name c·ªßa b·∫°n
const CLOUDINARY_UPLOAD_PRESET = "checkin_images"; // T√™n Upload Preset ƒë√£ t·∫°o
const Maps_API_KEY = ""; // N·∫øu b·∫°n mu·ªën d√πng ch·ª©c nƒÉng t·ª± ƒë·ªông l·∫•y v·ªã tr√≠
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const COMMON_PASS = "112233";

onAuthStateChanged(auth, user => {
    if (user) {
        showAppView(user);
    } else {
        showLoginView();
    }
});

function showLoginView() {
    document.getElementById("login-view").classList.remove("hidden");
    document.getElementById("app-view").classList.add("hidden");
}

function showAppView(user) {
    document.getElementById("login-view").classList.add("hidden");
    document.getElementById("app-view").classList.remove("hidden");
    const isAdmin = user.email.toLowerCase().startsWith("ad_");
    document.getElementById("user-info").textContent = user.email;

    if (isAdmin) {
        document.getElementById("user-info").textContent += " (Admin)";
        document.getElementById("admin-panel").classList.remove("hidden");
        document.getElementById("checkin-form-card").classList.add("hidden");
        document.getElementById("user-history-card").classList.add("hidden");
        loadAdminUsers();
    } else {
        document.getElementById("admin-panel").classList.add("hidden");
        document.getElementById("checkin-form-card").classList.remove("hidden");
        document.getElementById("user-history-card").classList.remove("hidden");
        loadUserHistory(user.uid);
    }
}

document.getElementById("login-email").addEventListener("input", () => {
    const emailVal = document.getElementById("login-email").value.trim();
    if (emailVal.toLowerCase().startsWith("ad_")) {
        document.getElementById("password-wrapper").classList.remove("hidden");
    } else {
        document.getElementById("password-wrapper").classList.add("hidden");
    }
});

document.getElementById("login-btn").addEventListener("click", async () => {
    const email = document.getElementById("login-email").value.trim();
    const password = email.toLowerCase().startsWith("ad_") ?
        document.getElementById("login-password").value :
        COMMON_PASS;

    if (!email || (!password && email.toLowerCase().startsWith("ad_"))) {
        document.getElementById("login-error").textContent = "Vui l√≤ng nh·∫≠p th√¥ng tin";
        return;
    }
    try {
        const userCred = await signInWithEmailAndPassword(auth, email, password);
        const user = userCred.user;
        const userRef = doc(db, 'usersInfo', user.uid);
        await setDoc(userRef, { email: user.email }, { merge: true });
        document.getElementById("login-error").textContent = "";
    } catch (error) {
        document.getElementById("login-error").textContent = "Sai th√¥ng tin ƒëƒÉng nh·∫≠p";
        console.error("Login error:", error);
    }
});

document.getElementById("logout-btn").addEventListener("click", async () => {
    await signOut(auth);
});

function loadUserHistory(userId) {
    const q = query(collection(db, `users/${userId}/checkins`), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => renderList(snapshot, document.getElementById("checkin-list")));
}

function loadAdminUsers() {
    const usersInfoRef = collection(db, 'usersInfo');
    onSnapshot(usersInfoRef, (snapshot) => {
        const userListContainer = document.getElementById("user-list");
        userListContainer.innerHTML = "";
        snapshot.forEach(doc => {
            const user = doc.data();
            const userDiv = document.createElement("div");
            userDiv.textContent = user.email;
            userDiv.onclick = () => {
                document.querySelectorAll('.user-list-sidebar div').forEach(div => div.classList.remove('active'));
                userDiv.classList.add('active');
                loadUserCheckins(doc.id);
            };
            userListContainer.appendChild(userDiv);
        });
    });
}

function loadUserCheckins(userId) {
    const detailContainer = document.getElementById("admin-checkin-detail");
    detailContainer.innerHTML = '<p>ƒêang t·∫£i...</p>';
    const q = query(collection(db, `users/${userId}/checkins`), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => renderList(snapshot, detailContainer));
}

function renderList(snapshot, container) {
    container.innerHTML = "";
    if (snapshot.empty) {
        container.innerHTML = '<p>Kh√¥ng c√≥ d·ªØ li·ªáu.</p>';
        return;
    }
    snapshot.forEach(doc => {
        const d = doc.data();
        const time = d.createdAt?.toDate().toLocaleString("vi-VN") || "";
        container.innerHTML += `
            <div class="checkin-item">
                <small>${time}</small><br>
                <span><b>V·ªã tr√≠:</b> ${d.manualLocation || ""}</span><br>
                <span><b>Ghi ch√∫:</b> ${d.notes || ""}</span><br>
                <img src="${d.photoURL}" alt="Checkin">
            </div>
            <hr>
        `;
    });
}

document.getElementById("checkin-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const photoFile = document.getElementById("photo").files && document.getElementById("photo").files.length > 0 ? document.getElementById("photo").files : null;
    const location = document.getElementById("manual-location").value.trim();
    const notes = document.getElementById("notes").value.trim();

    if (!photoFile || !location || !CLOUDINARY_CLOUD_NAME || !CLOUDINARY_UPLOAD_PRESET) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† c·∫•u h√¨nh Cloudinary.");
        return;
    }

    const user = auth.currentUser;
    const formData = new FormData();
    formData.append('file', photoFile.item(0));
    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    formData.append('folder', `checkin_photos/${user.uid}`);

    try {
        const response = await fetch(
            `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`,
            {
                method: 'POST',
                body: formData
            }
        );
        const data = await response.json();
        const photoURL = data.secure_url;

        await addDoc(collection(db, `users/${user.uid}/checkins`), {
            photoURL,
            manualLocation: location,
            notes,
            createdAt: serverTimestamp(),
            userId: user.uid,
            userEmail: user.email
        });

        alert("Check-in th√†nh c√¥ng!");
        e.target.reset();
        document.getElementById("image-preview").style.display = "none";
    } catch (error) {
        console.error("L·ªói khi t·∫°o check-in:", error);
        alert("C√≥ l·ªói x·∫£y ra, vui l√≤ng th·ª≠ l·∫°i.");
    }
});

document.getElementById("photo").addEventListener("change", (e) => {
    const file = e.target.files && e.target.files.length > 0 ? e.target.files.item(0) : null;
    const imagePreview = document.getElementById("image-preview");
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
            imagePreview.src = ev.target.result;
            imagePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
    } else {
        imagePreview.style.display = "none";
    }
});

document.getElementById("get-location-btn").addEventListener("click", () => {
    if (!Maps_API_KEY) {
        alert("Ch∆∞a c·∫•u h√¨nh Google Maps API Key.");
        return;
    }
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${Maps_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results && data.results[0]) {
                    document.getElementById("manual-location").value = data.results[0].formatted_address;
                }
            } catch (error) {
                console.error("L·ªói khi l·∫•y ƒë·ªãa ch·ªâ:", error);
                alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c ƒë·ªãa ch·ªâ t·ª´ Google Maps.");
            }
        }, () => alert("Kh√¥ng l·∫•y ƒë∆∞·ª£c v·ªã tr√≠. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p ƒë·ªãnh v·ªã."));
    } else {
        alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã.");
    }
});
</script>
</body>
</html>
