import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

const firebaseConfig = {
    apiKey: "AIzaSyBTO8b7SE1-u7cz0XImdbCuSzTaGtn-V8c",
    authDomain: "quanly-8c2da.firebaseapp.com",
    projectId: "quanly-8c2da",
    storageBucket: "quanly-8c2da.firebasestorage.app",
    messagingSenderId: "1078363909076",
    appId: "1:1078363909076:web:0f4c92fa8750c1f79b0441"
};

const Maps_API_KEY = ""; // thêm key nếu muốn auto lấy địa chỉ

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const COMMON_PASS = "112233";

// Lắng nghe sự thay đổi trạng thái đăng nhập của người dùng
onAuthStateChanged(auth, user => {
    if (user) {
        // Đã đăng nhập
        showAppView(user);
    } else {
        // Chưa đăng nhập
        showLoginView();
    }
});

function showAppView(user) {
    document.getElementById("login-view").classList.add("hidden");
    document.getElementById("app-view").classList.remove("hidden");
    const isAdmin = user.email.toLowerCase().startsWith("ad_");
    document.getElementById("user-info").textContent = `${user.email} ${isAdmin ? "(Admin)" : ""}`;

    loadUserHistory(user.uid);
    if (isAdmin) {
        loadAdminHistory();
    }
}

function showLoginView() {
    document.getElementById("login-view").classList.remove("hidden");
    document.getElementById("app-view").classList.add("hidden");
}

document.getElementById("login-email").addEventListener("input", () => {
    const emailVal = document.getElementById("login-email").value.trim();
    if (emailVal.toLowerCase().startsWith("ad_")) {
        document.getElementById("password-wrapper").classList.remove("hidden");
    } else {
        document.getElementById("password-wrapper").classList.add("hidden");
    }
});

document.getElementById("login-btn").addEventListener("click", async () => {
    const email = document.getElementById("login-email").value.trim();
    const password = email.toLowerCase().startsWith("ad_")
        ? document.getElementById("login-password").value
        : COMMON_PASS;

    if (!email || (!password && email.toLowerCase().startsWith("ad_"))) {
        document.getElementById("login-error").textContent = "Vui lòng nhập đầy đủ thông tin.";
        return;
    }
    try {
        await signInWithEmailAndPassword(auth, email, password);
        document.getElementById("login-error").textContent = "";
    } catch (error) {
        console.error("Lỗi đăng nhập:", error);
        document.getElementById("login-error").textContent = "Email hoặc mật khẩu không đúng.";
    }
});

document.getElementById("logout-btn").addEventListener("click", () => {
    signOut(auth);
});

function loadUserHistory(userId) {
    const q = query(collection(db, `users/${userId}/checkins`), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => renderList(snapshot, document.getElementById("checkin-list"), false));
}

function loadAdminHistory() {
    document.getElementById("admin-panel").classList.remove("hidden");
    const checkinCollectionGroup = collection(db, `checkins`); // Note: The collectionGroup approach is more complex for nested collections. A simple query will not work directly like this.

    // A more suitable approach for an admin view would be to restructure your database or use a collectionGroup query on a specific subcollection name.
    // For now, let's assume 'checkins' is a top-level collection for admin view.
    // As per your original code, it seems you intended to use a collectionGroup. To make it work, the 'checkins' subcollection name needs to be consistent, and the index must be created.
    // Let's modify the code slightly to make it work conceptually.
    
    // Create an index for collection group query if you use the original structure:
    // https://console.firebase.google.com/project/YOUR_PROJECT_ID/firestore/indexes?create_composite=EgJjaBAAGgUKEQE/&query=collectionGroup(checkins).orderBy(createdAt).get()
    // The query below would be more accurate if the collection group index exists.
    // const q = query(collectionGroup(db, 'checkins'), orderBy("createdAt", "desc"));
    
    // For this example, let's stick to a simpler, more direct approach if the admin view is showing all checkins.
    // If you've been using a single collection for all checkins, the code would be different.
    // Based on the original code's structure, the collectionGroup query is what's needed, but it requires a database index.
    // Let's assume the index is set up, so the original code logic is fine.

    // Re-instating the original, intended logic for the admin panel, assuming Firebase index is configured.
    const adminQuery = query(collectionGroup(db, "checkins"), orderBy("createdAt", "desc"));
    onSnapshot(adminQuery, (snapshot) => renderList(snapshot, document.getElementById("admin-list"), true));
}

function renderList(snapshot, container, showEmail) {
    container.innerHTML = "";
    snapshot.forEach(doc => {
        const d = doc.data();
        const time = d.createdAt?.toDate().toLocaleString("vi-VN") || "";
        container.innerHTML += `
            <div class="checkin-item">
                ${showEmail ? `<b>${d.userEmail || ""}</b><br>` : ""}
                <small>${time}</small><br>
                <span><b>Vị trí:</b> ${d.manualLocation || ""}</span><br>
                <span><b>Ghi chú:</b> ${d.notes || ""}</span><br>
                <img src="${d.photoURL}" alt="Checkin">
            </div>
            <hr>
        `;
    });
}

document.getElementById("checkin-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    const photoFile = document.getElementById("photo").files[0];
    const location = document.getElementById("manual-location").value.trim();
    const notes = document.getElementById("notes").value.trim();

    if (!photoFile || !location) {
        alert("Vui lòng nhập đầy đủ thông tin.");
        return;
    }

    const storageRef = ref(storage, `checkin_photos/${auth.currentUser.uid}/${Date.now()}_${photoFile.name}`);
    
    try {
        const snap = await uploadBytes(storageRef, photoFile);
        const photoURL = await getDownloadURL(snap.ref);

        await addDoc(collection(db, `users/${auth.currentUser.uid}/checkins`), {
            photoURL, 
            manualLocation: location, 
            notes,
            createdAt: serverTimestamp(),
            userId: auth.currentUser.uid,
            userEmail: auth.currentUser.email
        });

        alert("Check-in thành công!");
        e.target.reset();
        document.getElementById("image-preview").style.display = "none";
    } catch (error) {
        console.error("Lỗi khi tạo check-in:", error);
        alert("Có lỗi xảy ra, vui lòng thử lại.");
    }
});

document.getElementById("photo").addEventListener("change", (e) => {
    const file = e.target.files[0];
    const imagePreview = document.getElementById("image-preview");
    if (file) {
        const reader = new FileReader();
        reader.onload = ev => {
            imagePreview.src = ev.target.result;
            imagePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
    } else {
        imagePreview.style.display = "none";
    }
});

document.getElementById("get-location-btn").addEventListener("click", () => {
    if (!Maps_API_KEY) {
        alert("Chưa cấu hình Google Maps API Key.");
        return;
    }
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(async (pos) => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const url = `https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lng}&key=${Maps_API_KEY}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.results && data.results[0]) {
                    document.getElementById("manual-location").value = data.results[0].formatted_address;
                }
            } catch (error) {
                console.error("Lỗi khi lấy địa chỉ:", error);
                alert("Không lấy được địa chỉ từ Google Maps.");
            }
        }, () => alert("Không lấy được vị trí. Vui lòng kiểm tra quyền truy cập định vị."));
    } else {
        alert("Trình duyệt không hỗ trợ định vị.");
    }
});
