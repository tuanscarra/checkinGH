<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Check-in Giao Hàng</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {0% {transform: rotate(0deg);}100% {transform: rotate(360deg);}}
        #image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 0.5rem;
            object-fit: cover;
        }
        .modal-overlay {transition: opacity 0.3s ease;}
    </style>
</head>
<body class="text-gray-800">

<!-- Loading screen -->
<div id="loading-view" class="fixed inset-0 bg-gray-100 flex items-center justify-center">
    <div class="flex flex-col items-center">
        <div class="loader"></div>
        <p class="mt-4 text-gray-600">Đang tự động đăng nhập...</p>
    </div>
</div>

<!-- Main App -->
<main id="app-view" class="hidden">
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8 relative">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">Trình Quản Lý Giao Hàng</h1>
            <div class="mt-4 text-sm text-gray-600" id="user-info"></div>
        </header>

        <!-- Check-in form -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Tạo Check-in Mới</h2>
            <form id="checkin-form">
                <div class="mb-4">
                    <label for="photo" class="block text-gray-700 font-medium mb-2"><i class="fas fa-camera mr-2"></i>Ảnh Check-in</label>
                    <input type="file" id="photo" name="photo" accept="image/*" required
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <div class="mt-4 text-center"><img id="image-preview" class="hidden" alt="Xem trước ảnh"/></div>
                </div>
                <div class="mb-4">
                    <label for="manual-location" class="block text-gray-700 font-medium mb-2"><i class="fas fa-map-marker-alt mr-2"></i>Vị trí (nhập thủ công)</label>
                    <input type="text" id="manual-location" name="manual-location" placeholder="Ví dụ: 123 Đường ABC, Quận 1"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="notes" class="block text-gray-700 font-medium mb-2"><i class="fas fa-pencil-alt mr-2"></i>Ghi Chú</label>
                    <textarea id="notes" name="notes" rows="4"
                        placeholder="Ví dụ: Giao hàng cho anh A, đã nhận đủ tiền..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                </div>
                <div class="flex items-center justify-end">
                    <div id="loader" class="loader hidden mr-4"></div>
                    <button type="submit" id="submit-btn"
                        class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-300">
                        <i class="fas fa-paper-plane mr-2"></i>Gửi Check-in
                    </button>
                </div>
            </form>
            <div id="error-message" class="text-red-500 mt-4 text-center font-medium"></div>
        </div>

        <!-- Check-in history -->
        <div>
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Lịch Sử Check-in</h2>
            <div class="bg-white p-4 rounded-lg shadow-md mb-6 flex flex-col md:flex-row gap-4 items-center">
                <div class="w-full md:flex-1">
                    <input type="text" id="filter-text" placeholder="Tìm theo ghi chú..."
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="w-full md:w-auto">
                    <input type="date" id="filter-date"
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="clear-filters"
                    class="w-full md:w-auto bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">Xóa lọc</button>
            </div>
            <div id="checkin-list" class="space-y-6">
                <p id="no-checkin-message" class="text-center text-gray-500 py-8">Chưa có lần check-in nào.</p>
            </div>
        </div>
    </div>
</main>

<!-- Modal đổi mật khẩu -->
<div id="password-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
    <div class="modal-overlay absolute inset-0 bg-black opacity-50"></div>
    <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-lg z-10">
        <h2 class="text-2xl font-bold mb-6">Đổi Mật Khẩu</h2>
        <form id="password-change-form">
            <div class="mb-4">
                <label for="new-password" class="block text-gray-700 font-medium mb-2">Mật khẩu mới</label>
                <input type="password" id="new-password" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <label for="confirm-password" class="block text-gray-700 font-medium mb-2">Xác nhận mật khẩu mới</label>
                <input type="password" id="confirm-password" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end gap-4">
                <button type="button" id="cancel-password-change"
                    class="bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-400">Hủy</button>
                <button type="submit"
                    class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Lưu thay đổi</button>
            </div>
            <p id="password-change-message" class="text-center mt-4"></p>
        </form>
    </div>
</div>

<!-- Firebase SDK + Logic -->
<script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyBTO8b7SE1-u7cz0XImdbCuSzTaGtn-V8c",
      authDomain: "quanly-8c2da.firebaseapp.com",
      projectId: "quanly-8c2da",
      storageBucket: "quanly-8c2da.firebasestorage.app",
      messagingSenderId: "1078363909076",
      appId: "1:1078363909076:web:0f4c92fa8750c1f79b0441"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const loadingView = document.getElementById('loading-view');
    const appView = document.getElementById('app-view');
    const userInfo = document.getElementById('user-info');
    const checkinForm = document.getElementById('checkin-form');
    const photoInput = document.getElementById('photo');
    const manualLocationInput = document.getElementById('manual-location');
    const notesInput = document.getElementById('notes');
    const checkinList = document.getElementById('checkin-list');
    const errorMessage = document.getElementById('error-message');
    const loader = document.getElementById('loader');
    const submitBtn = document.getElementById('submit-btn');
    const imagePreview = document.getElementById('image-preview');
    const filterTextInput = document.getElementById('filter-text');
    const filterDateInput = document.getElementById('filter-date');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const passwordModal = document.getElementById('password-modal');
    const passwordChangeForm = document.getElementById('password-change-form');
    const cancelPasswordChangeBtn = document.getElementById('cancel-password-change');
    const passwordChangeMessage = document.getElementById('password-change-message');

    let allCheckins = [];
    let currentUser = null;
    let unsubscribeFromCheckins = null;

    const setupTestUser = async () => {
        try {
            await signInAnonymously(auth);
        } catch (error) {
            console.error("Lỗi khi đăng nhập:", error);
        }
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loadingView.classList.add('hidden');
            appView.classList.remove('hidden');
            userInfo.innerHTML = `
                <span>Đã đăng nhập với: <strong>${user.email || 'Ẩn danh'}</strong></span>
                <button id="change-password-btn" class="ml-4 bg-yellow-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-yellow-600 text-sm">Đổi mật khẩu</button>
                <button id="logout-btn" class="ml-2 bg-red-500 text-white font-bold py-1 px-3 rounded-lg hover:bg-red-600 text-sm">Đăng xuất</button>
            `;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.getElementById('change-password-btn').addEventListener('click', () => passwordModal.classList.remove('hidden'));
            listenForCheckins();
        } else {
            currentUser = null;
            loadingView.classList.add('hidden');
            appView.classList.add('hidden');
            setupTestUser();
            if (unsubscribeFromCheckins) unsubscribeFromCheckins();
            allCheckins = [];
            renderCheckins();
        }
    });

    cancelPasswordChangeBtn.addEventListener('click', () => {
        passwordModal.classList.add('hidden');
        passwordChangeForm.reset();
        passwordChangeMessage.textContent = '';
    });

    passwordModal.querySelector('.modal-overlay').addEventListener('click', () => cancelPasswordChangeBtn.click());

    passwordChangeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPassword = passwordChangeForm['new-password'].value;
        const confirmPassword = passwordChangeForm['confirm-password'].value;
        passwordChangeMessage.textContent = '';

        if (newPassword.length < 6) {
            passwordChangeMessage.className = 'text-red-500 text-center mt-4';
            passwordChangeMessage.textContent = 'Mật khẩu mới phải có ít nhất 6 ký tự.';
            return;
        }
        if (newPassword !== confirmPassword) {
            passwordChangeMessage.className = 'text-red-500 text-center mt-4';
            passwordChangeMessage.textContent = 'Mật khẩu xác nhận không khớp.';
            return;
        }
        try {
            await updatePassword(currentUser, newPassword);
            passwordChangeMessage.className = 'text-green-500 text-center mt-4';
            passwordChangeMessage.textContent = 'Đổi mật khẩu thành công!';
            setTimeout(() => cancelPasswordChangeBtn.click(), 2000);
        } catch (error) {
            passwordChangeMessage.className = 'text-red-500 text-center mt-4';
            passwordChangeMessage.textContent = 'Lỗi, vui lòng đăng nhập lại.';
        }
    });

    photoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                imagePreview.src = event.target.result;
                imagePreview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        } else {
            imagePreview.classList.add('hidden');
        }
    });

    checkinForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentUser) return;
        const photoFile = photoInput.files[0];
        const manualLocation = manualLocationInput.value.trim();
        const notes = notesInput.value.trim();
        if (!photoFile) {
            errorMessage.textContent = "Vui lòng chọn ảnh.";
            return;
        }
        if (!manualLocation) {
            errorMessage.textContent = "Vui lòng nhập vị trí.";
            return;
        }
        loader.classList.remove('hidden');
        submitBtn.disabled = true;
        errorMessage.textContent = "";
        try {
            const storageRef = ref(storage, `/users/${currentUser.uid}/checkins/${Date.now()}_${photoFile.name}`);
            const snapshot = await uploadBytes(storageRef, photoFile);
            const photoURL = await getDownloadURL(snapshot.ref);
            await addDoc(collection(db, `/users/${currentUser.uid}/checkins`), {
                photoURL, manualLocation, notes, createdAt: serverTimestamp(),
                userId: currentUser.uid, userEmail: currentUser.email || 'Ẩn danh'
            });
            checkinForm.reset();
            imagePreview.classList.add('hidden');
            errorMessage.textContent = "Check-in thành công!";
            errorMessage.className = "text-green-500 mt-4 text-center font-medium";
            setTimeout(() => errorMessage.textContent = "", 3000);
        } catch (error) {
            errorMessage.textContent = `Lỗi: ${error.message}`;
        } finally {
            loader.classList.add('hidden');
            submitBtn.disabled = false;
        }
    });

    function listenForCheckins() {
        if (!currentUser) return;
        const q = query(collection(db, `/users/${currentUser.uid}/checkins`));
        if (unsubscribeFromCheckins) unsubscribeFromCheckins();
        unsubscribeFromCheckins = onSnapshot(q, (querySnapshot) => {
            const data = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            allCheckins = data.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
            renderCheckins();
        });
    }

    function renderCheckins() {
        const searchText = filterTextInput.value.toLowerCase();
        const filterDate = filterDateInput.value;
        const filtered = allCheckins.filter(checkin => {
            const notesMatch = (checkin.notes || '').toLowerCase().includes(searchText);
            let dateMatch = true;
            if (filterDate && checkin.createdAt) {
                const checkinDate = checkin.createdAt.toDate().toISOString().split('T')[0];
                dateMatch = checkinDate === filterDate;
            }
            return notesMatch && dateMatch;
        });
        checkinList.innerHTML = '';
        if (filtered.length === 0) {
            checkinList.innerHTML = `<p class="text-center text-gray-500 py-8">Không tìm thấy check-in phù hợp.</p>`;
        } else {
            filtered.forEach(checkin => {
                const date = checkin.createdAt ? checkin.createdAt.toDate() : new Date();
                const formattedTime = date.toLocaleString('vi-VN', { dateStyle: 'short', timeStyle: 'short' });
                const el = document.createElement('div');
                el.className = 'bg-white p-5 rounded-lg shadow-md flex flex-col md:flex-row gap-5 items-start';
                el.innerHTML = `
                    <div class="w-full md:w-1/3">
                        <a href="${checkin.photoURL}" target="_blank"><img src="${checkin.photoURL}" onerror="this.src='https://placehold.co/400x300?text=No+Image';" alt="Ảnh check-in" class="rounded-lg w-full h-auto object-cover"></a>
                    </div>
                    <div class="w-full md:w-2/3">
                        <p class="text-xs text-gray-400 mb-2 font-semibold">${checkin.userEmail}</p>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-clock mr-2"></i>${formattedTime}</p>
                        <p class="text-gray-800 mb-3 whitespace-pre-wrap">${checkin.notes || '<em>Không có ghi chú</em>'}</p>
                        <p class="text-sm text-gray-800"><i class="fas fa-map-marker-alt mr-2"></i>Vị trí: ${checkin.manualLocation || '<em>Không có vị trí</em>'}</p>
                    </div>
                `;
                checkinList.appendChild(el);
            });
        }
    }

    filterTextInput.addEventListener('input', renderCheckins);
    filterDateInput.addEventListener('change', renderCheckins);
    clearFiltersBtn.addEventListener('click', () => {
        filterTextInput.value = '';
        filterDateInput.value = '';
        renderCheckins();
    });
</script>
</body>
</html>
